<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Análisis de Imagen con IA (Gemini)</title>
    <!-- Carga de Tailwind CSS para un diseño limpio y responsivo -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilos CSS para el fondo de tablero de ajedrez (simula la transparencia) */
        .checkerboard-bg {
            background-image: 
                linear-gradient(45deg, #ddd 25%, transparent 25%),
                linear-gradient(-45deg, #ddd 25%, transparent 25%),
                linear-gradient(45deg, transparent 75%, #ddd 75%),
                linear-gradient(-45deg, transparent 75%, #ddd 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
        }

        /* Oculta la imagen de IA que no se usa en esta versión */
        .processed-image { display: none; }

        /* Estilo para el spinner de carga */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #3b82f6; /* Color azul de Tailwind */
            animation: spin 1s ease infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 sm:p-8 font-sans">

    <div class="max-w-4xl mx-auto bg-white p-6 sm:p-10 rounded-xl shadow-2xl">
        <h1 class="text-3xl sm:text-4xl font-extrabold text-blue-800 mb-4 text-center">
            Análisis de Imagen con IA (Gemini)
        </h1>
        <p class="text-gray-600 mb-8 text-center">
            Esta aplicación usa la IA para identificar y describir el sujeto principal de la imagen, que es el primer paso para una remoción de fondo real.
        </p>

        <!-- Selector de Archivo -->
        <div class="mb-8 text-center">
            <!-- Etiqueta con estilo de botón para el input de tipo file -->
            <label for="image-upload" class="inline-block px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 cursor-pointer transition duration-300 shadow-md">
                Seleccionar Imagen
            </label>
            <input type="file" id="image-upload" accept="image/*" class="hidden">
        </div>
        
        <!-- Previsualizaciones y Análisis -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            
            <!-- Imagen Original -->
            <div class="p-4 border border-gray-200 rounded-lg shadow-inner">
                <h2 class="text-xl font-bold mb-3 text-gray-700">Imagen Original</h2>
                <div class="bg-gray-200 h-64 flex items-center justify-center rounded-md overflow-hidden">
                    <img id="original-image" src="#" alt="Imagen Original" class="max-h-full max-w-full object-contain transition duration-500" style="display: none;">
                    <p id="original-placeholder" class="text-gray-500">Carga una imagen</p>
                </div>
            </div>
            
            <!-- Análisis de la IA -->
            <div class="p-4 border-4 border-dashed border-red-400 rounded-lg shadow-xl">
                <h2 class="text-xl font-bold mb-3 text-red-600">Análisis del Sujeto con IA</h2>
                <div class="relative h-64 rounded-md p-4 flex flex-col items-center justify-center text-left overflow-y-auto">
                    <!-- Contenedor del Spinner -->
                    <div id="loading-indicator" class="hidden flex flex-col items-center justify-center">
                        <div class="spinner mb-3"></div>
                        <p class="text-gray-600">Analizando con Gemini...</p>
                    </div>

                    <!-- Resultado del Análisis -->
                    <p id="processed-result" class="text-gray-800 hidden"></p>
                    <p id="processed-placeholder" class="text-gray-500">El resultado de la IA aparecerá aquí.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Bloque JavaScript para la funcionalidad de la aplicación -->
    <script>
        // Variables del DOM
        const fileInput = document.getElementById('image-upload');
        const originalImage = document.getElementById('original-image');
        const originalPlaceholder = document.getElementById('original-placeholder');
        const processedPlaceholder = document.getElementById('processed-placeholder');
        const processedResult = document.getElementById('processed-result');
        const loadingIndicator = document.getElementById('loading-indicator');

        const apiKey = ""; // La clave API será proporcionada por el entorno de Canvas
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

        /**
         * Convierte un archivo File o Blob a una cadena Base64.
         * @param {File} file - El archivo de imagen.
         * @returns {Promise<string>} La cadena Base64 de los datos de la imagen.
         */
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    // Extrae solo la parte Base64 (después de 'data:image/jpeg;base64,')
                    const base64Data = reader.result.split(',')[1];
                    resolve(base64Data);
                };
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }

        /**
         * Realiza una llamada a la API con reintentos y retroceso exponencial.
         * @param {object} payload - El cuerpo de la solicitud JSON.
         * @param {number} maxRetries - El número máximo de reintentos.
         * @returns {Promise<object>} La respuesta de la API.
         */
        async function fetchWithRetry(payload, maxRetries = 5) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        return await response.json();
                    } else if (response.status === 429 || response.status >= 500) {
                        // Es un error de rate limiting o del servidor, reintentar
                        if (i < maxRetries - 1) {
                            const delay = Math.pow(2, i) * 1000;
                            await new Promise(resolve => setTimeout(resolve, delay));
                        } else {
                            throw new Error(`Fallo después de ${maxRetries} reintentos: ${response.statusText}`);
                        }
                    } else {
                        // Otros errores (400, 401, etc.), no reintentar
                        throw new Error(`Error de la API: ${response.statusText}`);
                    }
                } catch (error) {
                    if (i === maxRetries - 1) {
                        throw error;
                    }
                    const delay = Math.pow(2, i) * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }


        /**
         * Llama a la API de Gemini para analizar la imagen.
         * @param {string} base64Data - La imagen codificada en Base64.
         * @param {string} mimeType - El tipo MIME de la imagen (ej: 'image/jpeg').
         */
        async function analyzeImage(base64Data, mimeType) {
            processedPlaceholder.style.display = 'none';
            processedResult.style.display = 'none';
            loadingIndicator.style.display = 'flex'; // Mostrar cargador

            const userPrompt = "Identifica y describe con detalle el sujeto principal o el objeto en primer plano de esta imagen, pensando en términos de qué parte debe conservarse si se fuera a eliminar el fondo. Sé conciso.";

            const payload = {
                contents: [{
                    role: "user",
                    parts: [
                        { text: userPrompt },
                        {
                            inlineData: {
                                mimeType: mimeType,
                                data: base64Data
                            }
                        }
                    ]
                }],
            };

            try {
                const result = await fetchWithRetry(payload);
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;

                if (text) {
                    processedResult.textContent = text;
                    processedResult.style.display = 'block';
                } else {
                    processedResult.textContent = "Error: No se pudo obtener el análisis de la IA.";
                    processedResult.style.display = 'block';
                }

            } catch (error) {
                console.error("Error al llamar a la API de Gemini:", error);
                processedResult.textContent = `Error: Fallo la conexión o el análisis. (${error.message})`;
                processedResult.style.display = 'block';
            } finally {
                loadingIndicator.style.display = 'none'; // Ocultar cargador
            }
        }


        /**
         * Maneja la carga de la imagen.
         */
        fileInput.addEventListener('change', async function(event) {
            const file = event.target.files[0];
            if (file) {
                // 1. Mostrar original
                const imageUrl = URL.createObjectURL(file);
                originalImage.src = imageUrl;
                originalImage.style.display = 'block';
                originalPlaceholder.style.display = 'none';

                // 2. Analizar con IA
                try {
                    const base64Data = await fileToBase64(file);
                    await analyzeImage(base64Data, file.type);
                } catch (error) {
                    console.error("Error en la carga o análisis:", error);
                    processedResult.textContent = "Error al procesar el archivo.";
                    processedResult.style.display = 'block';
                    loadingIndicator.style.display = 'none';
                }
            }
        });
    </script>
</body>
</html>
