<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Removedor de Fondo con IA (Gemini)</title>
    <!-- Carga de Tailwind CSS para un diseño limpio y responsivo -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilos CSS para el fondo de tablero de ajedrez (simula la transparencia) */
        .checkerboard-bg {
            background-image: 
                linear-gradient(45deg, #ddd 25%, transparent 25%),
                linear-gradient(-45deg, #ddd 25%, transparent 25%),
                linear-gradient(45deg, transparent 75%, #ddd 75%),
                linear-gradient(-45deg, transparent 75%, #ddd 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
        }

        /* Estilo para el spinner de carga */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #3b82f6; /* Color azul de Tailwind */
            animation: spin 1s ease infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 sm:p-8 font-sans">

    <div class="max-w-4xl mx-auto bg-white p-6 sm:p-10 rounded-xl shadow-2xl">
        <h1 class="text-3xl sm:text-4xl font-extrabold text-blue-800 mb-4 text-center">
            Removedor de Fondo con IA (Gemini)
        </h1>
        <p class="text-gray-600 mb-8 text-center">
            Esta aplicación usa la IA para intentar generar una nueva imagen dejando el fondo **transparente**.
        </p>

        <!-- Selector de Archivo -->
        <div class="mb-8 text-center">
            <!-- Etiqueta con estilo de botón para el input de tipo file -->
            <label for="image-upload" class="inline-block px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 cursor-pointer transition duration-300 shadow-md">
                Seleccionar Imagen
            </label>
            <input type="file" id="image-upload" accept="image/*" class="hidden">
        </div>
        
        <!-- Previsualizaciones y Análisis -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            
            <!-- Imagen Original -->
            <div class="p-4 border border-gray-200 rounded-lg shadow-inner">
                <h2 class="text-xl font-bold mb-3 text-gray-700">Imagen Original</h2>
                <div class="bg-gray-200 h-64 flex items-center justify-center rounded-md overflow-hidden">
                    <img id="original-image" src="#" alt="Imagen Original" class="max-h-full max-w-full object-contain transition duration-500" style="display: none;">
                    <p id="original-placeholder" class="text-gray-500">Carga una imagen</p>
                </div>
            </div>
            
            <!-- Imagen Generada con Fondo Removido -->
            <div class="p-4 border-4 border-dashed border-green-400 rounded-lg shadow-xl">
                <h2 class="text-xl font-bold mb-3 text-green-600">Fondo Removido (Generado por IA)</h2>
                <div class="relative h-64 rounded-md overflow-hidden">
                    <!-- Fondo de tablero para hacer visible la transparencia -->
                    <div class="checkerboard-bg absolute inset-0 z-10"></div>
                    
                    <!-- Imagen generada por la IA -->
                    <img id="processed-image" src="#" alt="Imagen Procesada" class="absolute inset-0 w-full h-full object-contain z-20 transition duration-500" style="display: none;">
                    
                    <!-- Contenedor del Spinner o Placeholder -->
                    <div id="loading-indicator" class="absolute inset-0 z-30 bg-white/70 flex flex-col items-center justify-center hidden">
                        <div class="spinner mb-3"></div>
                        <p class="text-gray-600">Generando imagen sin fondo...</p>
                    </div>
                    <p id="processed-placeholder" class="text-gray-500 absolute inset-0 flex items-center justify-center z-30">La imagen sin fondo aparecerá aquí.</p>
                    
                    <!-- Contenedor de errores -->
                    <p id="error-message" class="text-red-500 absolute inset-0 flex items-center justify-center z-30 hidden p-4 text-center"></p>
                </div>
                <!-- Botón de Descarga -->
                <button id="download-button" class="mt-4 w-full px-4 py-2 bg-green-500 text-white font-semibold rounded-lg hover:bg-green-600 transition duration-300 shadow-md disabled:opacity-50" style="display: none;" disabled>
                    Descargar Imagen
                </button>
            </div>
        </div>
    </div>

    <!-- Bloque JavaScript para la funcionalidad de la aplicación -->
    <script>
        // Variables del DOM
        const fileInput = document.getElementById('image-upload');
        const originalImage = document.getElementById('original-image');
        const processedImage = document.getElementById('processed-image');
        const originalPlaceholder = document.getElementById('original-placeholder');
        const processedPlaceholder = document.getElementById('processed-placeholder');
        const loadingIndicator = document.getElementById('loading-indicator');
        const errorMessage = document.getElementById('error-message');
        const downloadButton = document.getElementById('download-button');
        
        // Configuración de la API para Image Editing (gemini-2.5-flash-image-preview)
        const apiKey = "";
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${apiKey}`;

        /**
         * Convierte un archivo File o Blob a una cadena Base64.
         */
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    // Extrae solo la parte Base64 (después de 'data:image/png;base64,')
                    const base64Data = reader.result.split(',')[1];
                    resolve(base64Data);
                };
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }

        /**
         * Realiza una llamada a la API con reintentos y retroceso exponencial.
         */
        async function fetchWithRetry(payload, maxRetries = 5) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        return await response.json();
                    } else if (response.status === 429 || response.status >= 500) {
                        if (i < maxRetries - 1) {
                            const delay = Math.pow(2, i) * 1000;
                            await new Promise(resolve => setTimeout(resolve, delay));
                        } else {
                            throw new Error(`Fallo después de ${maxRetries} reintentos: ${response.statusText}`);
                        }
                    } else {
                        throw new Error(`Error de la API: ${response.statusText}`);
                    }
                } catch (error) {
                    if (i === maxRetries - 1) {
                        throw error;
                    }
                    const delay = Math.pow(2, i) * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }


        /**
         * Llama a la API de Gemini para generar la imagen con el fondo removido.
         */
        async function removeBackground(base64Data, mimeType) {
            // Limpiar y mostrar indicadores de carga
            processedPlaceholder.style.display = 'none';
            processedImage.style.display = 'none';
            errorMessage.style.display = 'none';
            downloadButton.style.display = 'none';
            loadingIndicator.style.display = 'flex'; 

            // Prompt de edición: pedir a la IA que deje el fondo transparente
            const userPrompt = "Remueve completamente el fondo de esta imagen, dejando solo el sujeto principal y haciendo el resto del área completamente transparente. El formato de salida debe conservar la transparencia (PNG).";

            const payload = {
                contents: [{
                    role: "user",
                    parts: [
                        { text: userPrompt },
                        {
                            inlineData: {
                                mimeType: mimeType,
                                data: base64Data
                            }
                        }
                    ]
                }],
                generationConfig: {
                    responseModalities: ['IMAGE'] // Solicitamos solo imagen
                },
            };

            try {
                const result = await fetchWithRetry(payload);
                
                // Buscar la data base64 de la imagen generada
                const base64DataNew = result?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;

                if (base64DataNew) {
                    const imageUrl = `data:image/png;base64,${base64DataNew}`;
                    processedImage.src = imageUrl;
                    processedImage.style.display = 'block';

                    // Preparar el botón de descarga
                    downloadButton.onclick = () => {
                        const link = document.createElement('a');
                        link.href = imageUrl;
                        link.download = 'fondo_removido.png';
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                    };
                    downloadButton.disabled = false;
                    downloadButton.style.display = 'block';

                } else {
                    errorMessage.textContent = "Error: No se pudo obtener la imagen procesada de la IA. Intenta con una imagen más clara o sencilla.";
                    errorMessage.style.display = 'flex';
                }

            } catch (error) {
                console.error("Error al llamar a la API de Gemini:", error);
                errorMessage.textContent = `Error de conexión o proceso. Intenta de nuevo. (${error.message})`;
                errorMessage.style.display = 'flex';
            } finally {
                loadingIndicator.style.display = 'none'; // Ocultar cargador
            }
        }


        /**
         * Maneja la carga de la imagen.
         */
        fileInput.addEventListener('change', async function(event) {
            const file = event.target.files[0];
            if (file) {
                // 1. Mostrar original
                const imageUrl = URL.createObjectURL(file);
                originalImage.src = imageUrl;
                originalImage.style.display = 'block';
                originalPlaceholder.style.display = 'none';
                
                // 2. Intentar remover el fondo
                try {
                    const base64Data = await fileToBase64(file);
                    // Usamos file.type para el mimeType
                    await removeBackground(base64Data, file.type); 
                } catch (error) {
                    console.error("Error en la carga o análisis:", error);
                    errorMessage.textContent = "Error al procesar el archivo. Asegúrate de que sea una imagen válida.";
                    errorMessage.style.display = 'flex';
                    loadingIndicator.style.display = 'none';
                }
            }
        });
    </script>
</body>
</html>
